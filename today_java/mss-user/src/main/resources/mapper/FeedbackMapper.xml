<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.microservice.skeleton.user.mapper.FeedbackMapper">

    <!-- 通用结果集映射：Feedback 实体类 → FeedbackResponse 响应类 -->
    <resultMap id="FeedbackResponseMap" type="com.microservice.skeleton.user.domain.Response.FeedbackResponse">
        <!-- 基础字段映射 -->
        <id property="id" column="id"/>
        <result property="userId" column="user_id"/>
        <result property="title" column="title"/>
        <result property="content" column="content"/>
        <result property="type" column="type"/>
        <result property="contact" column="contact"/>
        <result property="status" column="status"/>
        <result property="replyContent" column="reply_content"/>

        <result property="createdAt" column="created_at"/>
        <result property="repliedAt" column="replied_at"/>
        <!-- 扩展字段（Service 中设置 typeName/statusName，XML 无需映射） -->
        <result property="typeName" column=""/>
        <result property="statusName" column=""/>
    </resultMap>

    <!-- 通用查询字段：避免重复书写 -->
    <sql id="selectFeedbackColumns">
        id, user_id, title, content, type, contact, images, status,
        reply_content, replied_by, replied_at, created_at, updated_at
    </sql>

    <!-- 1. 获取用户的反馈列表（按创建时间倒序） -->
    <select id="selectFeedbackByUserId" resultMap="FeedbackResponseMap">
        SELECT
        <include refid="selectFeedbackColumns"/>
        FROM
        feedback
        WHERE
        user_id = #{userId}
        ORDER BY
        created_at DESC
    </select>

    <!-- 2. 分页获取反馈列表（管理员用，支持状态筛选） -->
    <select id="selectFeedbackPage" resultMap="FeedbackResponseMap">
        SELECT
        <include refid="selectFeedbackColumns"/>
        FROM
        feedback
        WHERE
        <if test="status != null">AND status = #{status}</if> <!-- 状态筛选（可选） -->
        ORDER BY
        created_at DESC
    </select>

    <!-- 3. 获取反馈详情（包含完整信息） -->
    <select id="selectFeedbackDetail" resultMap="FeedbackResponseMap">
        SELECT
        <include refid="selectFeedbackColumns"/>
        FROM
        feedback
        WHERE
        id = #{id}
    </select>

</mapper>
